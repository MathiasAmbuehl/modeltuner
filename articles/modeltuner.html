<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="modeltuner">
<title>An introduction to modeltuner with examples • modeltuner</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="An introduction to modeltuner with examples">
<meta property="og:description" content="modeltuner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">modeltuner</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.9</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/modeltuner.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/ifm.html">Fitting and tuning Iteratively Fitted Models</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>An introduction to modeltuner with examples</h1>
                        <h4 data-toc-skip class="author">Mathias
Ambuehl</h4>
            
            <h4 data-toc-skip class="date">2023-09-22</h4>
      
      
      <div class="d-none name"><code>modeltuner.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mathiasambuehl.github.io/modeltuner/">modeltuner</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>   <span class="co"># for pipe operator</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>cv_verbose <span class="op">=</span> <span class="cn">FALSE</span>, width <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="basics">Basics<a class="anchor" aria-label="anchor" href="#basics"></a>
</h2>
<p>The package <strong>modeltuner</strong> offers a toolkit for model
evaluation, model comparison and hyperparameter tuning based on
cross-validation. It applies to models for a continuous or binary
response that are generated with the formula interface. In addition, it
includes functionalities for conveniently fitting and tuning xgboost and
glmnet models.</p>
<div class="section level3">
<h3 id="the-formula-interface">The formula interface<a class="anchor" aria-label="anchor" href="#the-formula-interface"></a>
</h3>
<p><code>modeltuner</code> is designed for model classes that are based
on a model-fitting functions using the <code>formula</code> interface in
combination with a <code>data</code> argument. Examples of model-fitting
functions matching this requirement are:</p>
<ul>
<li>in package <strong>stats</strong>: <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>,
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>, <code><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess()</a></code>, <code><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls()</a></code>
</li>
<li>in package <strong>robustbase</strong>: <code>lmrob()</code>,
<code>glmrob()</code>, <code>nlrob()</code>
</li>
<li>in package <strong>MASS</strong>: <code>rlm()</code>,
<code>lqs()</code>
</li>
<li>in package <strong>mgcv</strong>: <code>gam()</code>
</li>
<li>in package <strong>rpart</strong>: <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html" class="external-link">rpart()</a></code>
</li>
<li>in package <strong>quantreg</strong>: <code>rq()</code>
</li>
<li>in package <strong>lme4</strong>: <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code>,
<code><a href="https://rdrr.io/pkg/lme4/man/glmer.html" class="external-link">glmer()</a></code>
</li>
</ul>
<p><strong>modeltuner</strong> adds a few functions to this list which
are essentially formula-based wrappers to functions not supporting the
<code>formula</code> interface:</p>
<ul>
<li>
<code>fm_smoothing_spline()</code> uses
<code><a href="https://rdrr.io/r/stats/smooth.spline.html" class="external-link">stats::smooth.spline()</a></code>,</li>
<li>
<code><a href="../reference/fm_knn.html">fm_knn()</a></code> uses <code><a href="https://rdrr.io/pkg/RANN/man/nn2.html" class="external-link">RANN::nn2()</a></code>
(nearest-neighbor),</li>
<li>
<code><a href="../reference/fm_xgb.html">fm_xgb()</a></code> uses <code><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgboost::xgb.train()</a></code>
</li>
<li>
<code><a href="../reference/fm_glmnet.html">fm_glmnet()</a></code> uses <code><a href="https://glmnet.stanford.edu/reference/glmnet.html" class="external-link">glmnet::glmnet()</a></code>
</li>
</ul>
<p>The package offers some particularly attractive tools for handling
what is called <em>iteratively fitted models</em> (IFM) here. For such a
model, the fitting process returns not just one single model (or model
parameterization), but rather a range of models (or model
parameterizations) of increasing structural complexity. Prominent
examples –and currently the only instances implemented in the package–
are gradient boosting (as implemented in package
<strong>xgboost</strong>) and Lasso regression and elastic nets
(available from package <strong>glmnet</strong>). Refer to the dedicated
vignette (<code><a href="../articles/ifm.html">vignette("ifm")</a></code>) for an overview of these
functionalities.</p>
</div>
<div class="section level3">
<h3 id="fitted-models-and-objects-of-class-model">
<em>Fitted models</em> and objects of class “model”<a class="anchor" aria-label="anchor" href="#fitted-models-and-objects-of-class-model"></a>
</h3>
<p>We use the term <em>fitted model</em> for the output of a
model-fitting function, such as <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>. In
<strong>modeltuner</strong>, models are alternatively represented as
objects of class “model”. Such a “model” object does not necessarily
contain the model fit, but it includes the information needed to refit
the model, notably the model fitting <em>call</em> and the complete
<em>data</em>.</p>
<p>Each model has a <em>label</em> used to identify it in printed output
and graphics, in particular when several models are compared. The
default label is <code>"model"</code>, but it is recommended to
attribute an informative label to each model you create.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm_lm_cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">dist</span> <span class="op">~</span> <span class="va">speed</span>, <span class="va">cars</span><span class="op">)</span>        <span class="co"># fitted model</span></span>
<span><span class="va">mod_lm_cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">fm_lm_cars</span>, label <span class="op">=</span> <span class="st">"lm_cars"</span><span class="op">)</span> <span class="co"># 'model' object</span></span>
<span><span class="va">mod_lm_cars</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "model" object ---</span></span>
<span><span class="co">##   label:          lm_cars</span></span>
<span><span class="co">##   model class:    lm</span></span>
<span><span class="co">##   formula:        dist ~ speed</span></span>
<span><span class="co">##   data:           data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   response_type:  continuous</span></span>
<span><span class="co">##   call:           lm(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">##   fit:            Object of class 'lm'</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">mod_lm_cars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "model_lm" "model"</span></span></code></pre>
<p>Note the generic setting <code>data=data</code> in the model
generating call of <code>model_lm_cars</code> in the printed output
above. This is convenient for cross-validation, where the model
generating call is repeatedly adjusted and executed internally, using
the data stored in the “model” object. A similar generic setting
<code>weights=weights</code> is imposed in case of a weighted model.</p>
<p>In order to obtain the fitted model corresponding to a given “model”
object, use <code><a href="../reference/fit.html">fit()</a></code>. In a sense, <code><a href="../reference/fit.html">fit()</a></code> is the
reverse operation of <code><a href="../reference/model.html">model()</a></code>. <code>fit(mod_lm_cars)</code>
essentially executes the call <code>mod_lm_cars$call</code> using the
data <code>mod_lm_cars$data</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">mod_lm_cars</span><span class="op">)</span>    <span class="co"># back to fitted models</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = dist ~ speed, data = cars)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">## (Intercept)        speed  </span></span>
<span><span class="co">##     -17.579        3.932</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/all.equal-methods.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">fm_lm_cars</span>, <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">mod_lm_cars</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="cross-validation">Cross validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h3>
<div class="section level4">
<h4 id="folds">Folds<a class="anchor" aria-label="anchor" href="#folds"></a>
</h4>
<p>The function <code><a href="../reference/make_folds.html">make_folds()</a></code> generates a set of groups for
cross validation, sometimes called “folds”. Its output essentially
consists in a list of integer vectors defining the <em>test</em> sets.
The complement of each test set is used as the corresponding
<em>training</em> set.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/make_folds.html">make_folds</a></span><span class="op">(</span><span class="va">cars</span><span class="op">)</span>              <span class="co"># 10-fold CV, the default</span></span></code></pre></div>
<pre><code><span><span class="co">## Validation procedure: Complete k-fold Cross-Validation</span></span>
<span><span class="co">##   Number of obs in data:  50</span></span>
<span><span class="co">##   Number of test sets:    10</span></span>
<span><span class="co">##   Size of test sets:       5</span></span>
<span><span class="co">##   Size of training sets:  45</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/make_folds.html">make_folds</a></span><span class="op">(</span><span class="va">cars</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 10</span></span>
<span><span class="co">##  $ : int [1:5] 15 18 31 34 36</span></span>
<span><span class="co">##  $ : int [1:5] 16 33 39 40 45</span></span>
<span><span class="co">##  $ : int [1:5] 11 24 25 42 47</span></span>
<span><span class="co">##  $ : int [1:5] 6 10 21 30 49</span></span>
<span><span class="co">##  $ : int [1:5] 3 4 13 28 38</span></span>
<span><span class="co">##  $ : int [1:5] 2 7 29 43 50</span></span>
<span><span class="co">##  $ : int [1:5] 14 20 22 23 48</span></span>
<span><span class="co">##  $ : int [1:5] 8 9 27 32 35</span></span>
<span><span class="co">##  $ : int [1:5] 1 5 12 17 44</span></span>
<span><span class="co">##  $ : int [1:5] 19 26 37 41 46</span></span>
<span><span class="co">##  - attr(*, "class")= chr [1:2] "folds" "list"</span></span>
<span><span class="co">##  - attr(*, "type")= chr "complete"</span></span>
<span><span class="co">##  - attr(*, "n")= int 50</span></span>
<span><span class="co">##  - attr(*, "stratified")= logi FALSE</span></span></code></pre>
<p>Using the argument <code>nfold</code> to create 5-fold
cross-validation:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/make_folds.html">make_folds</a></span><span class="op">(</span><span class="va">cars</span>, nfold <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Validation procedure: Complete k-fold Cross-Validation</span></span>
<span><span class="co">##   Number of obs in data:  50</span></span>
<span><span class="co">##   Number of test sets:     5</span></span>
<span><span class="co">##   Size of test sets:      10</span></span>
<span><span class="co">##   Size of training sets:  40</span></span></code></pre>
<p>Setting <code>nfold=p</code> with a value of <code>p</code> between 0
and 1 is also possible. Instead of a cross-validation, this evokes a
simple hold-out validation, where the model is fitted to the proportion
<span class="math inline">\((1-p) \cdot 100\%\)</span> of the data and
the remaining <span class="math inline">\(p \cdot 100\%\)</span> is used
for evaluation.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/make_folds.html">make_folds</a></span><span class="op">(</span><span class="va">cars</span>, nfold <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="co"># Simple hold-out validation with 30% of cases in test set</span></span></code></pre></div>
<pre><code><span><span class="co">## Validation procedure: Simple Hold-out Validation</span></span>
<span><span class="co">##   Number of obs in data:  50</span></span>
<span><span class="co">##   Number of test sets:     1</span></span>
<span><span class="co">##   Size of test set:       15</span></span>
<span><span class="co">##   Size of training set:   35</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="execute-a-cross-validation-cv">Execute a cross-validation: <code>cv()</code><a class="anchor" aria-label="anchor" href="#execute-a-cross-validation-cv"></a>
</h4>
<p><code><a href="../reference/make_folds.html">make_folds()</a></code> is used inside <code><a href="../reference/cv.html">cv()</a></code>, the core
function executing a cross-validation. By default, 10-fold CV is
performed, but this can be customized using arguments <code>nfold</code>
and <code>folds</code>,</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Executing a cross validation: cv()</span></span>
<span><span class="va">cv_cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">mod_lm_cars</span><span class="op">)</span></span>
<span><span class="va">cv_cars</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "cv" object containing 1 validated model ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Validation procedure: Complete k-fold Cross-Validation</span></span>
<span><span class="co">##   Number of obs in data:  50</span></span>
<span><span class="co">##   Number of test sets:    10</span></span>
<span><span class="co">##   Size of test sets:       5</span></span>
<span><span class="co">##   Size of training sets:  45</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'lm_cars':</span></span>
<span><span class="co">##   model class:  lm</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   metric:       rmse</span></span></code></pre>
<p><code><a href="../reference/cv.html">cv()</a></code> can also be applied directly to a <em>fitted</em>
model: <code>cv(fm_lm_cars)</code> executes
<code>fm_lm_cars %&gt;% model %&gt;% cv</code>, thus skipping the
<code>model</code> step. The method used in this case is
<code><a href="../reference/cv.html">cv.default()</a></code>.</p>
</div>
<div class="section level4">
<h4 id="evaluate-a-cross-validation-cv_performance">Evaluate a cross-validation: <code>cv_performance()</code><a class="anchor" aria-label="anchor" href="#evaluate-a-cross-validation-cv_performance"></a>
</h4>
<p>To evaluate a “cv” object, use <code><a href="../reference/cv_performance.html">cv_performance()</a></code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_cars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##         train_rmse test_rmse time_cv</span></span>
<span><span class="co">## lm_cars     15.013    14.812    0.02</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_cars</span>, metric <span class="op">=</span> <span class="st">"medae"</span><span class="op">)</span> <span class="co"># alternative metric, see ?metrics</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: medae</span></span>
<span><span class="co">##         train_medae test_medae time_cv</span></span>
<span><span class="co">## lm_cars      9.9791     10.739    0.02</span></span></code></pre>
<p>There are so-called “shortcut methods” of
<code>cv_perrormance()</code> that trigger several steps in the workflow
sketched above. Examples are <code><a href="../reference/cv_performance.html">cv_performance.model()</a></code> or
<code><a href="../reference/cv_performance.html">cv_performance.default()</a></code>.</p>
<p><code>cv_performance.model(x)</code> executes
<code>x %&gt;% cv %&gt;% cv_performance</code>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">mod_lm_cars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##         train_rmse test_rmse time_cv</span></span>
<span><span class="co">## lm_cars     15.002    14.395   0.012</span></span></code></pre>
<p>The method <code>cv_performance.default</code> is applied to a fitted
model and executes
<code>x %&gt;% model %&gt;% cv %&gt;% cv_performance</code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">fm_lm_cars</span><span class="op">)</span>     <span class="co"># cv_performance.default - applied to a fitted model</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##       train_rmse test_rmse time_cv</span></span>
<span><span class="co">## model      14.99    14.815   0.012</span></span></code></pre>
<p>A drawback of these shortcut methods is that potentially useful
interim results from cross-validation (the “cv” object) is not being
stored. It is useful to know that the result from the last execution of
<code><a href="../reference/cv.html">cv()</a></code> can be recovered at any time with
<code><a href="../reference/last_cv.html">last_cv()</a></code>.</p>
</div>
<div class="section level4">
<h4 id="saving-the-model-fits">Saving the model fits<a class="anchor" aria-label="anchor" href="#saving-the-model-fits"></a>
</h4>
<p>By default, the model fits from a cross validation are not saved. To
do so, set <code>keep_fits = TRUE</code> in <code><a href="../reference/cv.html">cv()</a></code>:</p>
<p>Keep the fitted models from the cross-validation:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_cars_fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">mod_lm_cars</span>, keep_fits <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/extract_fits.html">extract_fits()</a></code> can now be used to obtain the model fits
from a “cv” object. Besides the model fits, the resulting table also has
column containing the <code>folds</code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">cars_fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_fits.html">extract_fits</a></span><span class="op">(</span><span class="va">cv_cars_fits</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       folds lm_cars</span></span>
<span><span class="co">## 1  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 2  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 3  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 4  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 5  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 6  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 7  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 8  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 9  &lt;int&gt;[5]    &lt;lm&gt;</span></span>
<span><span class="co">## 10 &lt;int&gt;[5]    &lt;lm&gt;</span></span></code></pre>
<p>We could now extract the fitted coefficients of the 10 models as
follows:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">cars_fits</span><span class="op">$</span><span class="va">lm_cars</span>, <span class="va">coef</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                   [,1]       [,2]       [,3]       [,4]       [,5]       [,6]       [,7]       [,8]</span></span>
<span><span class="co">## (Intercept) -16.434962 -18.297725 -21.183227 -13.892332 -17.339967 -18.314134 -17.175287 -19.644122</span></span>
<span><span class="co">## speed         3.916652   4.000578   4.265483   3.634229   3.916122   3.969363   3.847343   3.999979</span></span>
<span><span class="co">##                   [,9]      [,10]</span></span>
<span><span class="co">## (Intercept) -14.096414 -19.856576</span></span>
<span><span class="co">## speed         3.731144   4.068375</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="multimodels">Multimodels<a class="anchor" aria-label="anchor" href="#multimodels"></a>
</h3>
<p>A multimodel combines several models in one object. In order to
create such a multimodel, we fit two alternative models to the
<code>cars</code> data.</p>
<p>Alternative model 1: LOESS (locally weighted polynomial regression)
with <code><a href="https://rdrr.io/r/stats/loess.html" class="external-link">stats::loess()</a></code>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm_loess_cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span><span class="va">dist</span> <span class="op">~</span> <span class="va">speed</span>, <span class="va">cars</span>,  </span>
<span>      control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/loess.control.html" class="external-link">loess.control</a></span><span class="op">(</span>surface <span class="op">=</span> <span class="st">"direct"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>(The control setting in loess() is necessary for predictions outside
of the range of the training data)</p>
<p>Alternative model 2: regression tree with
<code><a href="https://rdrr.io/pkg/rpart/man/rpart.html" class="external-link">rpart::rpart()</a></code>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm_rpart_cars</span> <span class="op">&lt;-</span> <span class="fu">rpart</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html" class="external-link">rpart</a></span><span class="op">(</span><span class="va">dist</span> <span class="op">~</span> <span class="va">speed</span>, <span class="va">cars</span><span class="op">)</span></span></code></pre></div>
<p>These three models are combined in a multimodel with the method
<code><a href="../reference/multimodel.html">c.model()</a></code>:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mm_cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>  <span class="co"># method c.model(): argument names are used as model labels</span></span>
<span>  lm <span class="op">=</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">fm_lm_cars</span><span class="op">)</span>, </span>
<span>  loess <span class="op">=</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">fm_loess_cars</span><span class="op">)</span>, </span>
<span>  rpart <span class="op">=</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">fm_rpart_cars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mm_cars</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "multimodel" object containing 3 models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'lm':</span></span>
<span><span class="co">##   model class:  lm</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         lm(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'loess':</span></span>
<span><span class="co">##   model class:  loess</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         loess(formula = dist ~ speed, data = data, control = loess.control(surface = "direct"))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'rpart':</span></span>
<span><span class="co">##   model class:  rpart</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         rpart::rpart(formula = dist ~ speed, data = data)</span></span></code></pre>
<p>Only models having the same response can be combined in a
multimodel.</p>
<p>Graphical illustration of the fits of the three models:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">speed_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">30</span>, <span class="fl">.1</span><span class="op">)</span>  <span class="co"># grid of data points along range of 'speed'</span></span>
<span><span class="va">preds_mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mm_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>speed <span class="op">=</span> <span class="va">speed_seq</span><span class="op">)</span><span class="op">)</span> <span class="co"># predictions for grid data</span></span>
<span><span class="va">preds_mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>  <span class="co"># reshape for ggplot</span></span>
<span>  speed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">speed_seq</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/label.html">label</a></span><span class="op">(</span><span class="va">mm_cars</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">speed_seq</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">preds_mm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">preds_mm</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">speed</span>, <span class="va">dist</span>, color <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cars</span>, color <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"cars data: comparison of model fits"</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="cross-validate-a-multimodel">Cross-validate a multimodel<a class="anchor" aria-label="anchor" href="#cross-validate-a-multimodel"></a>
</h3>
<p><code><a href="../reference/cv.html">cv()</a></code> and <code><a href="../reference/cv_performance.html">cv_performance()</a></code> are applied to a
multimodel exactly as to a model. The same set of folds is thereby used
for all three cross-validations.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">mm_cars</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_cars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##       train_rmse test_rmse time_cv</span></span>
<span><span class="co">## lm        15.021    14.228   0.012</span></span>
<span><span class="co">## loess     14.277    14.529   0.015</span></span>
<span><span class="co">## rpart     16.513    15.948   0.026</span></span></code></pre>
<p>The output of <code><a href="../reference/cv.html">cv()</a></code>, an object of class “cv”, has a
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method producing a scatter plot of response versus
predicted values using the out-of-sample predictions resulting from the
cross-validation.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cv_cars</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="find-the-best-fitting-model-tune">Find the best-fitting model: <code>tune()</code><a class="anchor" aria-label="anchor" href="#find-the-best-fitting-model-tune"></a>
</h3>
<p><code><a href="../reference/tune.html">tune()</a></code> applied to a “cv” object extracts the best
fitting model according to test performance.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tune: pick the best model</span></span>
<span><span class="fu"><a href="../reference/tune.html">tune</a></span><span class="op">(</span><span class="va">cv_cars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "model" object ---</span></span>
<span><span class="co">##   label:          lm</span></span>
<span><span class="co">##   model class:    lm</span></span>
<span><span class="co">##   formula:        dist ~ speed</span></span>
<span><span class="co">##   data:           data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   response_type:  continuous</span></span>
<span><span class="co">##   call:           lm(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">##   fit:            Object of class 'lm'</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tune.html">tune</a></span><span class="op">(</span><span class="va">cv_cars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">fit</span>  <span class="co"># back to fitted model</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = dist ~ speed, data = cars)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">## (Intercept)        speed  </span></span>
<span><span class="co">##     -17.579        3.932</span></span></code></pre>
<p>If applied to a multimodel, <code><a href="../reference/tune.html">tune()</a></code> will cross-validate
the multimodel and then return the best-fitting model. Different runs of
<code><a href="../reference/cv.html">cv()</a></code> use different folds and consequently yield varying
results, such that the “best” model picked by <code><a href="../reference/tune.html">tune()</a></code> can
vary, too. In order to impose a given set of folds, use the parameter
<code>folds</code> in <code><a href="../reference/cv.html">cv()</a></code>:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">mm_cars</span>, folds <span class="op">=</span> <span class="va">cv_cars</span><span class="op">$</span><span class="va">folds</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">cv_performance</span>  <span class="co"># Same results as cv_performance(cv_cars)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##       train_rmse test_rmse time_cv</span></span>
<span><span class="co">## lm        15.021    14.228   0.012</span></span>
<span><span class="co">## loess     14.277    14.529   0.015</span></span>
<span><span class="co">## rpart     16.513    15.948   0.026</span></span></code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">mm_cars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">cv_performance</span>   <span class="co"># Slightly different results</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##       train_rmse test_rmse time_cv</span></span>
<span><span class="co">## lm        15.040    14.754   0.012</span></span>
<span><span class="co">## loess     14.319    14.995   0.015</span></span>
<span><span class="co">## rpart     16.237    16.812   0.026</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="manipulation-of-multimodels-and-related-objects">Manipulation of multimodels and related objects<a class="anchor" aria-label="anchor" href="#manipulation-of-multimodels-and-related-objects"></a>
</h3>
<p>The <strong>modeltuner</strong> package comes with a number of
generic utility functions that are helpful for inspection and basic
manipulations of object of classes “model”, “multimodel”, “cv”,
“performance” (the output of <code><a href="../reference/cv_performance.html">cv_performance()</a></code>) and other.
Some of these are presented in this section.</p>
<div class="section level4">
<h4 id="number-of-models-and-model-labels-n_model-label">Number of models and model labels: <code>n_model()</code>,
<code>label()</code><a class="anchor" aria-label="anchor" href="#number-of-models-and-model-labels-n_model-label"></a>
</h4>
<p>Query the number of models in <code>mm_cars</code> and their
labels:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/label.html">n_model</a></span><span class="op">(</span><span class="va">mm_cars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/label.html">label</a></span><span class="op">(</span><span class="va">mm_cars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "lm"    "loess" "rpart"</span></span></code></pre>
<p>Modify model labels: <code>label&lt;-</code> or
<code>set_labels()</code></p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/label.html">set_label</a></span><span class="op">(</span><span class="va">mm_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m1"</span>, <span class="st">"m2"</span>, <span class="st">"m3"</span><span class="op">)</span><span class="op">)</span>  <span class="co"># or:  label(mm_cars) &lt;- c("m1", "m2", "m3")</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "multimodel" object containing 3 models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'm1':</span></span>
<span><span class="co">##   model class:  lm</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         lm(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'm2':</span></span>
<span><span class="co">##   model class:  loess</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         loess(formula = dist ~ speed, data = data, control = loess.control(surface = "direct"))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'm3':</span></span>
<span><span class="co">##   model class:  rpart</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         rpart::rpart(formula = dist ~ speed, data = data)</span></span></code></pre>
<p>The parameter <code>which</code> allows changing only a part of the
labels:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/label.html">set_label</a></span><span class="op">(</span><span class="va">mm_cars</span>, which <span class="op">=</span> <span class="fl">3</span>, <span class="st">"tree"</span><span class="op">)</span>    <span class="co"># changes only the third label (result not shown)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="subsetting-a-multimodel-or-cv-object-with-subset">Subsetting a multimodel or “cv” object with
<code>subset()</code><a class="anchor" aria-label="anchor" href="#subsetting-a-multimodel-or-cv-object-with-subset"></a>
</h4>
<p><code><a href="../reference/subset.html">subset.multimodel()</a></code> subsets a multimodel. The selection
can be made with an integer, character (giving model labels) or logical
(of appropriate length) vector.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/subset.html">subset</a></span><span class="op">(</span><span class="va">mm_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>  <span class="co"># i is integer</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "multimodel" object containing 2 models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'lm':</span></span>
<span><span class="co">##   model class:  lm</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         lm(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'rpart':</span></span>
<span><span class="co">##   model class:  rpart</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         rpart::rpart(formula = dist ~ speed, data = data)</span></span></code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/subset.html">subset</a></span><span class="op">(</span><span class="va">mm_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lm"</span>, <span class="st">"rpart"</span><span class="op">)</span><span class="op">)</span> <span class="co"># i is character - same result as above</span></span>
<span><span class="fu"><a href="../reference/subset.html">subset</a></span><span class="op">(</span><span class="va">mm_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">F</span>, <span class="cn">T</span><span class="op">)</span><span class="op">)</span>       <span class="co"># i is logical - same result as above</span></span></code></pre></div>
<p>The methods <code><a href="../reference/subset.html">subset.cv()</a></code> and
<code><a href="../reference/subset.html">subset.performance()</a></code> work analogously.</p>
</div>
<div class="section level4">
<h4 id="extraction-of-a-model-from-a-multimodel-or-cv-object-extract_model">Extraction of a model from a multimodel or “cv” object:
<code>extract_model()</code><a class="anchor" aria-label="anchor" href="#extraction-of-a-model-from-a-multimodel-or-cv-object-extract_model"></a>
</h4>
<p>While <code><a href="../reference/subset.html">subset.cv()</a></code> yields another “cv” object,
<code><a href="../reference/extract_model.html">extract_model()</a></code> extracts a single model from a “cv” object
or multimodel, returning an object of class “model”.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extract the first model</span></span>
<span><span class="fu"><a href="../reference/extract_model.html">extract_model</a></span><span class="op">(</span><span class="va">cv_cars</span>, <span class="fl">1</span><span class="op">)</span>  <span class="co"># i (second argument) is integer</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "model" object ---</span></span>
<span><span class="co">##   label:          lm</span></span>
<span><span class="co">##   model class:    lm</span></span>
<span><span class="co">##   formula:        dist ~ speed</span></span>
<span><span class="co">##   data:           data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   response_type:  continuous</span></span>
<span><span class="co">##   call:           lm(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">##   fit:            Object of class 'lm'</span></span></code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_model.html">extract_model</a></span><span class="op">(</span><span class="va">cv_cars</span>, <span class="st">"lm"</span><span class="op">)</span>       <span class="co"># i is character - same result as above</span></span>
<span><span class="fu"><a href="../reference/extract_model.html">extract_model</a></span><span class="op">(</span><span class="va">cv_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">T</span>, <span class="cn">F</span>, <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="co"># i is logical - same result as above</span></span></code></pre></div>
<p>Note that there is also a function <code><a href="../reference/extract_model.html">extract_multimodel()</a></code>,
which extracts the multimodel from a “cv” object.</p>
</div>
<div class="section level4">
<h4 id="sort-the-models-sort_models">Sort the models: <code>sort_models()</code><a class="anchor" aria-label="anchor" href="#sort-the-models-sort_models"></a>
</h4>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sort models</span></span>
<span><span class="fu"><a href="../reference/sort_models.html">sort_models</a></span><span class="op">(</span><span class="va">mm_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "multimodel" object containing 3 models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'lm':</span></span>
<span><span class="co">##   model class:  lm</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         lm(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'rpart':</span></span>
<span><span class="co">##   model class:  rpart</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         rpart::rpart(formula = dist ~ speed, data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'loess':</span></span>
<span><span class="co">##   model class:  loess</span></span>
<span><span class="co">##   formula:      dist ~ speed</span></span>
<span><span class="co">##   data:         data.frame [50 x 2], input as: 'data = cars'</span></span>
<span><span class="co">##   call:         loess(formula = dist ~ speed, data = data, control = loess.control(surface = "direct"))</span></span></code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sort_models.html">sort_models</a></span><span class="op">(</span><span class="va">mm_cars</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>  <span class="co"># same as above (omitted index 2 is appended)</span></span></code></pre></div>
<p>Sorting by performance and execution time is also possible:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_cars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/sort_models.html">sort_models</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"test"</span><span class="op">)</span> <span class="co"># not for multimodels</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##       train_rmse test_rmse time_cv</span></span>
<span><span class="co">## lm        15.021    14.228   0.012</span></span>
<span><span class="co">## loess     14.277    14.529   0.015</span></span>
<span><span class="co">## rpart     16.513    15.948   0.026</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_cars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/sort_models.html">sort_models</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span> <span class="co"># not for multimodels</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##       train_rmse test_rmse time_cv</span></span>
<span><span class="co">## lm        15.021    14.228   0.012</span></span>
<span><span class="co">## loess     14.277    14.529   0.015</span></span>
<span><span class="co">## rpart     16.513    15.948   0.026</span></span></code></pre>
<p><code><a href="../reference/label.html">n_model()</a></code>, <code><a href="../reference/label.html">label()</a></code>,
<code>label&lt;-</code>, <code><a href="../reference/label.html">set_label()</a></code>,
<code><a href="../reference/subset.html">subset()</a></code>, <code><a href="../reference/extract_model.html">extract_model()</a></code>,
<code>sort_model()</code> have specific methods for classes “model”,
“multimodel”, “cv” and “performance”. Their help topics have more
detailed information.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="hyperparameter-tuning">Hyperparameter tuning<a class="anchor" aria-label="anchor" href="#hyperparameter-tuning"></a>
</h2>
<div class="section level3">
<h3 id="motivating-example-parameter-k-in-k-nearest-neighbor">Motivating example: Parameter <code>k</code> in
k-nearest-neighbor<a class="anchor" aria-label="anchor" href="#motivating-example-parameter-k-in-k-nearest-neighbor"></a>
</h3>
<p>We now use the function <code><a href="../reference/fm_knn.html">fm_knn()</a></code> (from the modeltuner
package) to fit a k-nearest model to the <code>mycycle</code> data from
package <strong>MASS</strong>. The parameter <code>k</code>, the number
of neighbors, equals 5 by default.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mcycle</span>, package <span class="op">=</span> <span class="st">"MASS"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fm_mcycle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fm_knn.html">fm_knn</a></span><span class="op">(</span><span class="va">accel</span> <span class="op">~</span> <span class="va">times</span>, data <span class="op">=</span> <span class="va">mcycle</span><span class="op">)</span> <span class="co"># function from modeltuner; k=5 by default</span></span>
<span><span class="va">fm_mcycle</span></span></code></pre></div>
<pre><code><span><span class="co">## k-nearest neighbors model (class 'fm_knn')</span></span>
<span><span class="co">##   formula:      accel ~ times - 1</span></span>
<span><span class="co">##   data:         mcycle</span></span>
<span><span class="co">##   k:            5</span></span>
<span><span class="co">##   n:            133</span></span>
<span><span class="co">##   standardize:  TRUE</span></span>
<span><span class="co">##   weighted:     FALSE</span></span></code></pre>
<p>Illustration of the model fit:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First create a grid along the range of 'times' (used for graphs)</span></span>
<span><span class="va">preddat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mcycle</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">preddat</span><span class="op">$</span><span class="va">accel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fm_mcycle</span>, <span class="va">preddat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">preddat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">times</span>, <span class="va">accel</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mcycle</span>, col <span class="op">=</span> <span class="fl">4</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-33-1.png" width="672"></p>
<div class="section level4">
<h4 id="create-a-multimodel-with-multimodel">Create a multimodel with <code>multimodel()</code><a class="anchor" aria-label="anchor" href="#create-a-multimodel-with-multimodel"></a>
</h4>
<p>Next, a multimodel is generated that contains 25 “fm_knn”-models with
different choices of the parameter <code>k</code>:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kk</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span></span>
<span><span class="va">knn_mcycle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multimodel.html">multimodel</a></span><span class="op">(</span><span class="va">fm_mcycle</span>, k <span class="op">=</span> <span class="va">kk</span>, prefix <span class="op">=</span> <span class="st">"knn_mcycle"</span><span class="op">)</span></span>
<span><span class="va">knn_mcycle</span>  </span></code></pre></div>
<pre><code><span><span class="co">## --- A "multimodel" object containing 25 models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'knn_mcycle1':</span></span>
<span><span class="co">##   model class:  fm_knn</span></span>
<span><span class="co">##   formula:      accel ~ times</span></span>
<span><span class="co">##   data:         data.frame [133 x 2], input as: 'data = mcycle'</span></span>
<span><span class="co">##   call:         fm_knn(formula = accel ~ times, data = data, k = 1L)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'knn_mcycle2':</span></span>
<span><span class="co">##   model class:  fm_knn</span></span>
<span><span class="co">##   formula:      accel ~ times</span></span>
<span><span class="co">##   data:         data.frame [133 x 2], input as: 'data = mcycle'</span></span>
<span><span class="co">##   call:         fm_knn(formula = accel ~ times, data = data, k = 2L)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'knn_mcycle3':</span></span>
<span><span class="co">##   model class:  fm_knn</span></span>
<span><span class="co">##   formula:      accel ~ times</span></span>
<span><span class="co">##   data:         data.frame [133 x 2], input as: 'data = mcycle'</span></span>
<span><span class="co">##   call:         fm_knn(formula = accel ~ times, data = data, k = 3L)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## and 22 models more, labelled:</span></span>
<span><span class="co">##   'knn_mcycle4', 'knn_mcycle5', 'knn_mcycle6', 'knn_mcycle7', 'knn_mcycle8', 'knn_mcycle9', </span></span>
<span><span class="co">##   'knn_mcycle10', 'knn_mcycle11', 'knn_mcycle12', 'knn_mcycle13', 'knn_mcycle14', 'knn_mcycle15', </span></span>
<span><span class="co">##   'knn_mcycle16', 'knn_mcycle17', 'knn_mcycle18', 'knn_mcycle19', 'knn_mcycle20', 'knn_mcycle21', </span></span>
<span><span class="co">##   'knn_mcycle22', 'knn_mcycle23', 'knn_mcycle24', 'knn_mcycle25'</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parameter table:</span></span>
<span><span class="co">##               k</span></span>
<span><span class="co">## knn_mcycle1   1</span></span>
<span><span class="co">## knn_mcycle2   2</span></span>
<span><span class="co">## knn_mcycle3   3</span></span>
<span><span class="co">## ... 22 rows omitted (nrow=25)</span></span></code></pre>
<p>As opposed to a multimodel obtained by joining several model with
<code>c(...)</code>, a multimodel generated with
<code><a href="../reference/multimodel.html">multimodel()</a></code> has a <em>parameter table</em> that is
displayed when the multimodel is printed, see the output above.</p>
<p>The multimodel <code>mm_cycle</code> is cross-validated:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_mcycle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">knn_mcycle</span><span class="op">)</span> <span class="co"># Uses same folds for all models</span></span>
<span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_mcycle</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: rmse</span></span>
<span><span class="co">##               k train_rmse test_rmse time_cv</span></span>
<span><span class="co">## knn_mcycle1   1     17.622    33.649   0.023</span></span>
<span><span class="co">## knn_mcycle2   2     18.214    27.984   0.023</span></span>
<span><span class="co">## knn_mcycle3   3     19.671    26.292   0.022</span></span>
<span><span class="co">## knn_mcycle4   4     20.202    25.751   0.023</span></span>
<span><span class="co">## knn_mcycle5   5     20.397    25.726   0.022</span></span>
<span><span class="co">## knn_mcycle6   6     20.868    25.071   0.022</span></span>
<span><span class="co">## knn_mcycle7   7     21.178    25.116   0.023</span></span>
<span><span class="co">## knn_mcycle8   8     21.358    24.644   0.023</span></span>
<span><span class="co">## knn_mcycle9   9     21.781    24.611   0.023</span></span>
<span><span class="co">## knn_mcycle10 10     22.027    24.691   0.023</span></span>
<span><span class="co">## knn_mcycle11 11     22.177    24.594   0.023</span></span>
<span><span class="co">## knn_mcycle12 12     22.297    24.691   0.024</span></span>
<span><span class="co">## knn_mcycle13 13     22.479    24.654   0.025</span></span>
<span><span class="co">## knn_mcycle14 14     22.618    24.437   0.025</span></span>
<span><span class="co">## knn_mcycle15 15     22.865    24.689   0.031</span></span>
<span><span class="co">## knn_mcycle16 16     23.080    24.658   0.023</span></span>
<span><span class="co">## knn_mcycle17 17     23.290    24.732   0.023</span></span>
<span><span class="co">## knn_mcycle18 18     23.518    25.060   0.023</span></span>
<span><span class="co">## knn_mcycle19 19     23.816    25.436   0.024</span></span>
<span><span class="co">## knn_mcycle20 20     24.136    25.404   0.024</span></span>
<span><span class="co">## knn_mcycle21 21     24.391    25.546   0.023</span></span>
<span><span class="co">## knn_mcycle22 22     24.699    26.009   0.024</span></span>
<span><span class="co">## knn_mcycle23 23     25.031    26.311   0.024</span></span>
<span><span class="co">## knn_mcycle24 24     25.520    26.664   0.024</span></span>
<span><span class="co">## knn_mcycle25 25     25.932    27.045   0.026</span></span></code></pre>
<p>Note that the column(s) of the parameter table, <code>k</code> in our
example, are included in the output of
<code><a href="../reference/cv_performance.html">cv_performance()</a></code>.</p>
</div>
<div class="section level4">
<h4 id="plot-a-performance-table">Plot a performance table<a class="anchor" aria-label="anchor" href="#plot-a-performance-table"></a>
</h4>
<p>The output of <code><a href="../reference/cv_performance.html">cv_performance()</a></code> is a performance table,
of class “performance”. Its <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method displays a bar
chart by default.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_mcycle</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-36-1.png" width="672"></p>
<p>The vertical dotted line identifies the best-fitting model (w.r.t.
test error), i.e. the model that <code><a href="../reference/tune.html">tune()</a></code> would pick. The
horizontal dotted line shows the test error of this model.</p>
<p>In this example, the visual appearance of the plot can be improved by
setting the parameter <code>xvar</code>:</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_mcycle</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>xvar <span class="op">=</span> <span class="st">"k"</span><span class="op">)</span> <span class="co"># xvar a column of the performance table </span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-37-1.png" width="672"></p>
<p>Note that the training error of the 1-nearest neighbor model is
larger than zero. This is due to the presence of bindings
<code>mcycle$times</code>. Without bindings, the curve representing the
training error would start at a value of zero.</p>
<p>The next plot compares the model fits for a custom selection of four
values of <code>k</code>:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="fu"><a href="../reference/subset.html">subset</a></span><span class="op">(</span><span class="va">knn_mcycle</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span>, <span class="va">preddat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"knn_mcycle"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  times <span class="op">=</span> <span class="va">preddat</span><span class="op">$</span><span class="va">times</span>, </span>
<span>  accel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">times</span>, <span class="va">accel</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">model</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>col <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mcycle</span>, col <span class="op">=</span> <span class="fl">4</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-38-1.png" width="672"></p>
</div>
<div class="section level4">
<h4 id="plot-methods-for-multi-model-and-cv">Plot methods for (multi-)model and “cv”:<a class="anchor" aria-label="anchor" href="#plot-methods-for-multi-model-and-cv"></a>
</h4>
<p>The methods <code><a href="../reference/plot.model.html">plot.model()</a></code>, <code><a href="../reference/plot.model.html">plot.multimodel()</a></code>
and <code><a href="../reference/plot.model.html">plot.cv()</a></code> generate scatter plots (ggplots) of actual
responses versus predictions. <code><a href="../reference/plot.model.html">plot.model()</a></code> uses (in-sample)
predictions from a single model fit, while <code><a href="../reference/plot.model.html">plot.cv()</a></code>
displays the out-of-sample predictions resulting from the
cross-validation.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span>  <span class="co"># 1-nearest neighbor</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">arrangeGrob</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/subset.html">subset</a></span><span class="op">(</span><span class="va">knn_mcycle</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># fits the model and plots response vs. fitted</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"plot.model: in-sample fit of 1-NN"</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/subset.html">subset</a></span><span class="op">(</span><span class="va">cv_mcycle</span>, <span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># plots response vs. cv-fits</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"plot.cv: out-of-sample fit"</span><span class="op">)</span>, </span>
<span>  nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-39-1.png" width="672"></p>
<p>Plotting a multimodel or “cv” object including several models creates
the same type of plot with one panel/facet for each model.</p>
</div>
</div>
<div class="section level3">
<h3 id="tune-a-parameter">
<code>tune()</code> a parameter<a class="anchor" aria-label="anchor" href="#tune-a-parameter"></a>
</h3>
<div class="section level4">
<h4 id="starting-from-the-cv-object">Starting from the <code>cv</code> object:<a class="anchor" aria-label="anchor" href="#starting-from-the-cv-object"></a>
</h4>
<p><code><a href="../reference/tune.html">tune()</a></code> is a generic function, and it method
<code><a href="../reference/tune.html">tune.cv()</a></code> simply selects the best model according to test
error, thus returning a “model” object:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tune.html">tune</a></span><span class="op">(</span><span class="va">cv_mcycle</span><span class="op">)</span>          <span class="co"># Selects the best model according to test error</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "model" object ---</span></span>
<span><span class="co">##   label:          knn_mcycle14</span></span>
<span><span class="co">##   model class:    fm_knn</span></span>
<span><span class="co">##   formula:        accel ~ times</span></span>
<span><span class="co">##   data:           data.frame [133 x 2], input as: 'data = mcycle'</span></span>
<span><span class="co">##   response_type:  continuous</span></span>
<span><span class="co">##   call:           fm_knn(formula = accel ~ times, data = data, k = 14L)</span></span></code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tune.html">tune</a></span><span class="op">(</span><span class="va">cv_mcycle</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">fit</span>  <span class="co"># Back to non-modeltuner world (fitted model)</span></span></code></pre></div>
<pre><code><span><span class="co">## k-nearest neighbors model (class 'fm_knn')</span></span>
<span><span class="co">##   formula:      accel ~ times - 1</span></span>
<span><span class="co">##   data:         data</span></span>
<span><span class="co">##   k:            14</span></span>
<span><span class="co">##   n:            133</span></span>
<span><span class="co">##   standardize:  TRUE</span></span>
<span><span class="co">##   weighted:     FALSE</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="shortcut-methods-tune-model-and-tune-default">“Shortcut methods” <code>tune.model()</code> and
<code>tune.default()</code><a class="anchor" aria-label="anchor" href="#shortcut-methods-tune-model-and-tune-default"></a>
</h4>
<p><code><a href="../reference/tune.html">tune.model()</a></code> takes an object of class “model” and
returns a “tuned” version.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_mcycle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">fm_mcycle</span><span class="op">)</span></span>
<span><span class="va">mod_mcycle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/tune.html">tune</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span>   <span class="co"># "Dots" in tune(x, ...) are passed to multimodel()</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "model" object ---</span></span>
<span><span class="co">##   label:          model9</span></span>
<span><span class="co">##   model class:    fm_knn</span></span>
<span><span class="co">##   formula:        accel ~ times</span></span>
<span><span class="co">##   data:           data.frame [133 x 2], input as: 'data = mcycle'</span></span>
<span><span class="co">##   response_type:  continuous</span></span>
<span><span class="co">##   call:           fm_knn(formula = accel ~ times, data = data, k = 9L)</span></span></code></pre>
<p>The code line <code>mod_mcycle %&gt;% tune(k = 1:25)</code> executes
<code>mod_mcycle %&gt;% multimodel(k = 1:25) %&gt;% cv %&gt;% tune</code>.</p>
<p>Likewise, <code><a href="../reference/tune.html">tune.default()</a></code> takes a fitted model and
returns a fitted model (result not shown).</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm_mcycle</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/tune.html">tune</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">)</span></span></code></pre></div>
<p>This runs
<code>fm_mcycle %&gt;% model %&gt;% multimodel(k = 1:20) %&gt;% cv %&gt;% tune %&gt;% fit</code></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="binary-response">Binary response<a class="anchor" aria-label="anchor" href="#binary-response"></a>
</h2>
<p>We now fit a <code>glm</code> to the <code>kyphosis</code> data from
package <strong>rpart</strong>:</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bethatkinson/rpart" class="external-link">rpart</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">kyphosis</span>, package <span class="op">=</span> <span class="st">"rpart"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">kyphosis</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Kyphosis Age Number Start</span></span>
<span><span class="co">## 1   absent  71      3     5</span></span>
<span><span class="co">## 2   absent 158      3    14</span></span>
<span><span class="co">## 3  present 128      4     5</span></span>
<span><span class="co">## 4   absent   2      5     1</span></span>
<span><span class="co">## 5   absent   1      4    15</span></span>
<span><span class="co">## 6   absent   1      2    16</span></span></code></pre>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">kyphosis</span><span class="op">$</span><span class="va">Kyphosis</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  absent present </span></span>
<span><span class="co">##      64      17</span></span></code></pre>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># glm model (fitted model)</span></span>
<span><span class="va">glmmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Kyphosis</span> <span class="op">==</span> <span class="st">"present"</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">kyphosis</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">glmmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## glm(formula = Kyphosis == "present" ~ ., family = "binomial", </span></span>
<span><span class="co">##     data = kyphosis)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##              Estimate Std. Error z value Pr(&gt;|z|)   </span></span>
<span><span class="co">## (Intercept) -2.036934   1.449575  -1.405  0.15996   </span></span>
<span><span class="co">## Age          0.010930   0.006446   1.696  0.08996 . </span></span>
<span><span class="co">## Number       0.410601   0.224861   1.826  0.06785 . </span></span>
<span><span class="co">## Start       -0.206510   0.067699  -3.050  0.00229 **</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## (Dispersion parameter for binomial family taken to be 1)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     Null deviance: 83.234  on 80  degrees of freedom</span></span>
<span><span class="co">## Residual deviance: 61.380  on 77  degrees of freedom</span></span>
<span><span class="co">## AIC: 69.38</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of Fisher Scoring iterations: 5</span></span></code></pre>
<div class="section level3">
<h3 id="model-object">
<code>model</code> object<a class="anchor" aria-label="anchor" href="#model-object"></a>
</h3>
<p>In <strong>modeltuner</strong>, a binary response is expected to have
values 0 and 1. If this is the case, the <code>response_type</code> will
be “binary” (otherwise “continuous”), and <code><a href="../reference/cv_performance.html">cv_performance()</a></code>
will use the <code>logLoss</code> metric by default (in contrast to
<code>rmse</code> for a continuous response). See <code><a href="../reference/metrics.html">?metrics</a></code>
and <code><a href="../reference/default_metric.html">?default_metric</a></code> for more information.</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod1_kyph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="va">glmmod</span>, label <span class="op">=</span> <span class="st">"glm"</span><span class="op">)</span></span>
<span><span class="va">mod1_kyph</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "model" object ---</span></span>
<span><span class="co">##   label:          glm</span></span>
<span><span class="co">##   model class:    glm</span></span>
<span><span class="co">##   formula:        Kyphosis == "present" ~ Age + Number + Start</span></span>
<span><span class="co">##   data:           data.frame [81 x 4], input as: 'data = kyphosis'</span></span>
<span><span class="co">##   response_type:  binary</span></span>
<span><span class="co">##   call:           glm(formula = Kyphosis == "present" ~ ., family = "binomial", data = data)</span></span>
<span><span class="co">##   fit:            Object of classes 'glm', 'lm'</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="cross-validate-and-evaluate-result">Cross-validate and evaluate result<a class="anchor" aria-label="anchor" href="#cross-validate-and-evaluate-result"></a>
</h3>
<p>Below, <code>mod1_kyph</code> is cross-validated and the result is
evaluated with the default metric and a standard metric.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_kyph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">mod1_kyph</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_kyph</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: logLoss</span></span>
<span><span class="co">##     train_logLoss test_logLoss time_cv</span></span>
<span><span class="co">## glm       0.37571      0.44412   0.024</span></span></code></pre>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">cv_kyph</span>, metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cl_err <span class="op">=</span> <span class="va">classification_error</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: cl_err</span></span>
<span><span class="co">##     train_cl_err test_cl_err time_cv</span></span>
<span><span class="co">## glm      0.15638     0.22222   0.024</span></span></code></pre>
<div class="section level4">
<h4 id="plot-of-a-modelmultimodelcv-in-case-of-binary-response">Plot of a model/multimodel/cv in case of binary response:<a class="anchor" aria-label="anchor" href="#plot-of-a-modelmultimodelcv-in-case-of-binary-response"></a>
</h4>
<p><code><a href="../reference/plot.model.html">plot.model()</a></code> and <code><a href="../reference/plot.model.html">plot.cv()</a></code> generate two
separate violin plots of predicted values for the two groups of
observations having response value 0 and 1:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot.(multi)model and plot.cv in binary case</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">arrangeGrob</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1_kyph</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"plot.model: glm model"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod1_kyph</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">cv</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"plot.cv: glm model"</span><span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-46-1.png" width="672"></p>
</div>
</div>
<div class="section level3">
<h3 id="alternative-model-ranger">Alternative model: <code>ranger</code><a class="anchor" aria-label="anchor" href="#alternative-model-ranger"></a>
</h3>
<p>As an second model in the kyphosis example, <code><a href="https://rdrr.io/pkg/ranger/man/ranger.html" class="external-link">ranger()</a></code> is
used to fit a random forest:</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger" class="external-link">ranger</a></span><span class="op">)</span></span>
<span><span class="co"># without fitting the model...</span></span>
<span><span class="va">mod2_kyph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="st">"ranger"</span>, <span class="va">Kyphosis</span> <span class="op">==</span> <span class="st">"present"</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">kyphosis</span>, </span>
<span>                   num.trees <span class="op">=</span> <span class="fl">100</span>, max.depth <span class="op">=</span> <span class="fl">4</span>, </span>
<span>                   class <span class="op">=</span> <span class="st">"ranger"</span>, label <span class="op">=</span> <span class="st">"ranger"</span><span class="op">)</span></span></code></pre></div>
<p>The plot below shows that the random forest overfits the data in this
example:</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">arrangeGrob</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod2_kyph</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"plot.model"</span><span class="op">)</span>,  <span class="co"># overfits</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">mod2_kyph</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"plot.cv"</span><span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-48-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="combine-the-two-models-in-a-multimodel">Combine the two models in a multimodel<a class="anchor" aria-label="anchor" href="#combine-the-two-models-in-a-multimodel"></a>
</h3>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cv_performance</span></span>
<span><span class="va">mm_kyph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mod1_kyph</span>, <span class="va">mod2_kyph</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">mm_kyph</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: logLoss</span></span>
<span><span class="co">##        train_logLoss test_logLoss time_cv</span></span>
<span><span class="co">## glm          0.37465      0.46969   0.026</span></span>
<span><span class="co">## ranger       2.46928      7.71019   0.065</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="variable-selection-procedures-based-on-cross-validation">Variable selection procedures based on cross-validation<a class="anchor" aria-label="anchor" href="#variable-selection-procedures-based-on-cross-validation"></a>
</h2>
<p>The modeltuner package has a collection of functions that modify a
given model by adding or removing variables from the formula and
optionally cross-validate them.</p>
<p>For the sake of more compact formulas in printed output, we first
introduce a variable transformation in <code>kyphosis</code> and
redefine the model <code>mod1_kyph</code>:</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod1_kyph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">mod1_kyph</span>, </span>
<span>                    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">kyphosis</span>, </span>
<span>                                     kyphosisFlag <span class="op">=</span> <span class="va">Kyphosis</span> <span class="op">==</span> <span class="st">"present"</span><span class="op">)</span>, </span>
<span>                    formula <span class="op">=</span> <span class="va">kyphosisFlag</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="combine-all-models-resulting-from-removing-or-adding-one-variable">Combine all models resulting from removing or adding one
variable<a class="anchor" aria-label="anchor" href="#combine-all-models-resulting-from-removing-or-adding-one-variable"></a>
</h3>
<ul>
<li>
<code><a href="../reference/stepwise.html">step_reduce()</a></code> includes all models resulting from
removing one variable from the <em>full model</em>,</li>
<li>
<code><a href="../reference/stepwise.html">step_extend()</a></code> includes all models resulting from adding
one variable to <em>base model</em>.</li>
</ul>
<p>The <em>full model</em> and <em>base model</em> are defined in the
parameters <code>formula1</code> and <code>formula2</code>. When
<code>formula1</code> and <code>formula2</code> are not given by the
user, the actual model is taken as the full model and a bare intercept
model as the base model. See <code><a href="../reference/stepwise.html">?stepwise</a></code> for more details.
<code><a href="../reference/stepwise.html">step_reduce()</a></code> and <code><a href="../reference/stepwise.html">step_extend()</a></code> return a “cv”
object if the argument <code>cv</code> is <code>TRUE</code> (the
default) or a multimodel if <code>cv=FALSE</code>.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stepwise.html">step_reduce</a></span><span class="op">(</span><span class="va">mod1_kyph</span>, cv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># remove one variable from full model</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "multimodel" object containing 3 models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '-Age':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Number + Start</span></span>
<span><span class="co">##   data:         data.frame [81 x 5], </span></span>
<span><span class="co">##                 input as: 'data = transform(kyphosis, kyphosisFlag = Kyphosis == "present")'</span></span>
<span><span class="co">##   call:         glm(formula = kyphosisFlag ~ Number + Start, family = "binomial", data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '-Number':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Age + Start</span></span>
<span><span class="co">##   data:         data.frame [81 x 5], </span></span>
<span><span class="co">##                 input as: 'data = transform(kyphosis, kyphosisFlag = Kyphosis == "present")'</span></span>
<span><span class="co">##   call:         glm(formula = kyphosisFlag ~ Age + Start, family = "binomial", data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '-Start':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Age + Number</span></span>
<span><span class="co">##   data:         data.frame [81 x 5], </span></span>
<span><span class="co">##                 input as: 'data = transform(kyphosis, kyphosisFlag = Kyphosis == "present")'</span></span>
<span><span class="co">##   call:         glm(formula = kyphosisFlag ~ Age + Number, family = "binomial", data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parameter table:</span></span>
<span><span class="co">##                               formula</span></span>
<span><span class="co">## -Age    kyphosisFlag ~ Number + Start</span></span>
<span><span class="co">## -Number kyphosisFlag ~ Age + Start   </span></span>
<span><span class="co">## -Start  kyphosisFlag ~ Age + Number</span></span></code></pre>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stepwise.html">step_extend</a></span><span class="op">(</span><span class="va">mod1_kyph</span>, cv <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>  <span class="co"># add one variable to base model</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "multimodel" object containing 3 models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '+Age':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Age</span></span>
<span><span class="co">##   data:         data.frame [81 x 5], </span></span>
<span><span class="co">##                 input as: 'data = transform(kyphosis, kyphosisFlag = Kyphosis == "present")'</span></span>
<span><span class="co">##   call:         glm(formula = kyphosisFlag ~ Age, family = "binomial", data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '+Number':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Number</span></span>
<span><span class="co">##   data:         data.frame [81 x 5], </span></span>
<span><span class="co">##                 input as: 'data = transform(kyphosis, kyphosisFlag = Kyphosis == "present")'</span></span>
<span><span class="co">##   call:         glm(formula = kyphosisFlag ~ Number, family = "binomial", data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '+Start':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Start</span></span>
<span><span class="co">##   data:         data.frame [81 x 5], </span></span>
<span><span class="co">##                 input as: 'data = transform(kyphosis, kyphosisFlag = Kyphosis == "present")'</span></span>
<span><span class="co">##   call:         glm(formula = kyphosisFlag ~ Start, family = "binomial", data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parameter table:</span></span>
<span><span class="co">##                       formula</span></span>
<span><span class="co">## +Age    kyphosisFlag ~ Age   </span></span>
<span><span class="co">## +Number kyphosisFlag ~ Number</span></span>
<span><span class="co">## +Start  kyphosisFlag ~ Start</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="backward-elimination-and-forward-selection">Backward elimination and forward selection<a class="anchor" aria-label="anchor" href="#backward-elimination-and-forward-selection"></a>
</h3>
<ul>
<li>
<code><a href="../reference/stepwise.html">step_forward()</a></code> applies <code><a href="../reference/stepwise.html">step_extend()</a></code>
repeatedly, selecting the best model w.r.t. test error at each step,
thus performing a forward selection of variables.</li>
<li>
<code><a href="../reference/stepwise.html">step_backward()</a></code> applies <code><a href="../reference/stepwise.html">step_reduce()</a></code>
repeatedly, selecting the best model w.r.t. test error at each step,
thus performing a backward elimination of variables.</li>
</ul>
<p>Backward elimination:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">backwd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stepwise.html">step_backward</a></span><span class="op">(</span><span class="va">mod1_kyph</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "cv" object containing 4 validated models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Validation procedure: Complete k-fold Cross-Validation</span></span>
<span><span class="co">##   Number of obs in data:   81</span></span>
<span><span class="co">##   Number of test sets:     10</span></span>
<span><span class="co">##   Size of test sets:       ~8</span></span>
<span><span class="co">##   Size of training sets:  ~73</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Models:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## 'full':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Age + Number + Start</span></span>
<span><span class="co">##   metric:       logLoss</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '-Number':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Age + Start</span></span>
<span><span class="co">##   metric:       logLoss</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '-Age':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Start</span></span>
<span><span class="co">##   metric:       logLoss</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## and 1 model more, labelled:</span></span>
<span><span class="co">##   '-Start'</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parameter table:</span></span>
<span><span class="co">##                                     formula</span></span>
<span><span class="co">## full    kyphosisFlag ~ Age + Number + Start</span></span>
<span><span class="co">## -Number kyphosisFlag ~ Age + Start         </span></span>
<span><span class="co">## -Age    kyphosisFlag ~ Start               </span></span>
<span><span class="co">## -Start  kyphosisFlag ~ 1</span></span></code></pre>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv_performance.html">cv_performance</a></span><span class="op">(</span><span class="va">backwd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- Performance table ---</span></span>
<span><span class="co">## Metric: logLoss</span></span>
<span><span class="co">##                                     formula train_logLoss test_logLoss time_cv</span></span>
<span><span class="co">## full    kyphosisFlag ~ Age + Number + Start       0.37638      0.43046   0.032</span></span>
<span><span class="co">## -Number kyphosisFlag ~ Age + Start                0.40207      0.42260   0.021</span></span>
<span><span class="co">## -Age    kyphosisFlag ~ Start                      0.41942      0.43510   0.019</span></span>
<span><span class="co">## -Start  kyphosisFlag ~ 1                          0.51356      0.51815   0.017</span></span></code></pre>
<p>Plot the performance table of <code>backwd</code>:</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">backwd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">cv_performance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">plot</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-53-1.png" width="672"></p>
<p>Forward selection:</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forwd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stepwise.html">step_forward</a></span><span class="op">(</span><span class="va">mod1_kyph</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="best-subset-model-selection">Best subset model selection<a class="anchor" aria-label="anchor" href="#best-subset-model-selection"></a>
</h3>
<p><code><a href="../reference/stepwise.html">best_subset()</a></code> combines submodels of the full model in a
multimodel and subjects it to <code><a href="../reference/cv.html">cv()</a></code>. The desired range of
the model sizes (number of regressors) to include is specified in the
parameter <code>nvars</code>. <code><a href="../reference/stepwise.html">best_subset()</a></code> returns either
a “cv” object (if <code>cv=TRUE</code>, default) or a multimodel,
depending on parameter <code>cv</code>.</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># best subset selection</span></span>
<span><span class="op">(</span><span class="va">bestsub</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stepwise.html">best_subset</a></span><span class="op">(</span><span class="va">mod1_kyph</span>, nvars <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## --- A "cv" object containing 6 validated models ---</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Validation procedure: Complete k-fold Cross-Validation</span></span>
<span><span class="co">##   Number of obs in data:   81</span></span>
<span><span class="co">##   Number of test sets:     10</span></span>
<span><span class="co">##   Size of test sets:       ~8</span></span>
<span><span class="co">##   Size of training sets:  ~73</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Models:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '+Age':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Age</span></span>
<span><span class="co">##   metric:       logLoss</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '+Number':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Number</span></span>
<span><span class="co">##   metric:       logLoss</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## '+Start':</span></span>
<span><span class="co">##   model class:  glm</span></span>
<span><span class="co">##   formula:      kyphosisFlag ~ Start</span></span>
<span><span class="co">##   metric:       logLoss</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## and 3 models more, labelled:</span></span>
<span><span class="co">##   '+Age+Number', '+Age+Start', '+Number+Start'</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parameter table:</span></span>
<span><span class="co">##                                     formula</span></span>
<span><span class="co">## +Age          kyphosisFlag ~ Age           </span></span>
<span><span class="co">## +Number       kyphosisFlag ~ Number        </span></span>
<span><span class="co">## +Start        kyphosisFlag ~ Start         </span></span>
<span><span class="co">## ... 3 rows omitted (nrow=6)</span></span></code></pre>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bestsub</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="va">cv_performance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/sort_models.html">sort_models</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"test"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>   <span class="co"># sort models by test error</span></span>
<span>  <span class="va">plot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">30</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="modeltuner_files/figure-html/unnamed-chunk-55-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mathias Ambuehl.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
